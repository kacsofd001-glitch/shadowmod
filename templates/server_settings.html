<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Settings - Shadow-MOD</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo"><a href="/dashboard">Shadow-MOD</a></div>
            <div class="nav-links">
                <span class="user-info">
                    <img src="{{ avatar_url }}" alt="{{ username }}" class="user-avatar">
                    {{ username }}
                </span>
                <a href="/auth/logout" class="logout-btn">Logout</a>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="back-link">
            <a href="/dashboard">← Back to Servers</a>
        </div>

        <div class="settings-header">
            <h1>Server Settings</h1>
            <p id="guildId">Guild ID: {{ guild_id }}</p>
        </div>

        <div class="settings-tabs">
            <button class="tab-btn active" data-tab="moderation">Moderation</button>
            <button class="tab-btn" data-tab="automod">Auto Moderation</button>
            <button class="tab-btn" data-tab="logging">Logging</button>
            <button class="tab-btn" data-tab="welcome">Welcome</button>
            <button class="tab-btn" data-tab="badwords">Bad Words</button>
            <button class="tab-btn" data-tab="links">Whitelisted Links</button>
            <button class="tab-btn" data-tab="music">Music</button>
            <button class="tab-btn" data-tab="games">Games</button>
            <button class="tab-btn" data-tab="general">General</button>
        </div>

        <div class="settings-content">
            <!-- Moderation Tab -->
            <div class="tab-content active" id="moderation">
                <h2>Moderation Settings</h2>
                <form class="settings-form">
                    <div class="form-group">
                        <label for="warnThreshold">Warnings before kick:</label>
                        <input type="number" id="warnThreshold" name="moderation[warn_threshold]" min="1" max="20" placeholder="5">
                    </div>
                    <div class="form-group">
                        <label for="kickThreshold">Kicks before ban:</label>
                        <input type="number" id="kickThreshold" name="moderation[kick_threshold]" min="1" max="20" placeholder="3">
                    </div>
                    <div class="form-group">
                        <label for="defaultTimeout">Default timeout (minutes):</label>
                        <input type="number" id="defaultTimeout" name="moderation[default_timeout]" min="1" max="40320" placeholder="60">
                    </div>
                    <button type="submit" class="save-btn">Save Changes</button>
                </form>
            </div>

            <!-- Auto Moderation Tab -->
            <div class="tab-content" id="automod">
                <h2>Auto Moderation</h2>
                <form class="settings-form">
                    <div class="form-group">
                        <label for="spamDetection">
                            <input type="checkbox" id="spamDetection" name="automod[spam_detection]">
                            Enable Spam Detection
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="capsDetection">
                            <input type="checkbox" id="capsDetection" name="automod[caps_detection]">
                            Block Excessive Caps (>50%)
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="mentionLimit">Mention limit per message:</label>
                        <input type="number" id="mentionLimit" name="automod[mention_limit]" min="1" max="50" placeholder="5">
                    </div>
                    <button type="submit" class="save-btn">Save Changes</button>
                </form>
            </div>

            <!-- Logging Tab -->
            <div class="tab-content" id="logging">
                <h2>Logging Settings</h2>
                <form class="settings-form">
                    <div class="form-group">
                        <label for="logChannel">Log Channel ID:</label>
                        <input type="text" id="logChannel" name="logging[channel_id]" placeholder="Channel ID">
                    </div>
                    <div class="form-group">
                        <label for="logMessages">
                            <input type="checkbox" id="logMessages" name="logging[log_messages]">
                            Log deleted messages
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="logEdits">
                            <input type="checkbox" id="logEdits" name="logging[log_edits]">
                            Log edited messages
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="logMember">
                            <input type="checkbox" id="logMember" name="logging[log_member_updates]">
                            Log member updates
                        </label>
                    </div>
                    <button type="submit" class="save-btn">Save Changes</button>
                </form>
            </div>

            <!-- Welcome Tab -->
            <div class="tab-content" id="welcome">
                <h2>Welcome Settings</h2>
                <form class="settings-form">
                    <div class="form-group">
                        <label for="welcomeEnabled">
                            <input type="checkbox" id="welcomeEnabled" name="welcome[enabled]">
                            Enable welcome messages
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="welcomeChannel">Welcome Channel ID:</label>
                        <input type="text" id="welcomeChannel" name="welcome[channel_id]" placeholder="Channel ID">
                    </div>
                    <div class="form-group">
                        <label for="welcomeMessage">Welcome message:</label>
                        <textarea id="welcomeMessage" name="welcome[message]" placeholder="Welcome {user} to {server}!"></textarea>
                    </div>
                    <button type="submit" class="save-btn">Save Changes</button>
                </form>
            </div>

            <!-- Bad Words Tab -->
            <div class="tab-content" id="badwords">
                <h2>Bad Words Filter</h2>
                <form class="settings-form">
                    <div class="form-group">
                        <label>Add bad word:</label>
                        <div class="input-group">
                            <input type="text" id="newBadWord" placeholder="Enter word..." />
                            <button type="button" class="add-btn" onclick="addBadWord()">Add</button>
                        </div>
                    </div>
                    <div class="word-list" id="badWordsList"></div>
                    <button type="submit" class="save-btn">Save All Changes</button>
                </form>
            </div>

            <!-- Whitelisted Links Tab -->
            <div class="tab-content" id="links">
                <h2>Whitelisted Links</h2>
                <form class="settings-form">
                    <div class="form-group">
                        <label>Add whitelisted domain:</label>
                        <div class="input-group">
                            <input type="text" id="newLink" placeholder="example.com" />
                            <button type="button" class="add-btn" onclick="addLink()">Add</button>
                        </div>
                    </div>
                    <div class="link-list" id="linksList"></div>
                    <button type="submit" class="save-btn">Save All Changes</button>
                </form>
            </div>

            <!-- Music Tab -->
            <div class="tab-content" id="music">
                <h2>Music Settings</h2>
                <form class="settings-form">
                    <div class="form-group">
                        <label for="musicEnabled">
                            <input type="checkbox" id="musicEnabled" name="music_settings[enabled]">
                            Enable music commands
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="maxQueueSize">Max queue size:</label>
                        <input type="number" id="maxQueueSize" name="music_settings[max_queue]" min="10" max="1000" placeholder="100">
                    </div>
                    <button type="submit" class="save-btn">Save Changes</button>
                </form>
            </div>

            <!-- Games Tab -->
            <div class="tab-content" id="games">
                <h2>Games Settings</h2>
                <form class="settings-form">
                    <div class="form-group">
                        <label for="gamesEnabled">
                            <input type="checkbox" id="gamesEnabled" name="games_settings[enabled]">
                            Enable games
                        </label>
                    </div>
                    <button type="submit" class="save-btn">Save Changes</button>
                </form>
            </div>

            <!-- General Tab -->
            <div class="tab-content" id="general">
                <h2>General Settings</h2>
                <form class="settings-form">
                    <div class="form-group">
                        <label for="prefix">Command prefix:</label>
                        <input type="text" id="prefix" name="prefix" maxlength="3" placeholder="!">
                    </div>
                    <div class="form-group">
                        <label for="language">Language:</label>
                        <select id="language" name="language">
                            <option value="en">English</option>
                            <option value="hu">Hungarian</option>
                        </select>
                    </div>
                    <button type="submit" class="save-btn">Save Changes</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const guildId = '{{ guild_id }}';
        let currentSettings = {};

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });

        // Load settings
        async function loadSettings() {
            try {
                const response = await fetch(`/api/settings/${guildId}`);
                currentSettings = await response.json();
                populateForm();
            } catch (error) {
                console.error('Failed to load settings:', error);
                alert('Failed to load settings');
            }
        }

        function populateForm() {
            // Populate moderation
            document.getElementById('warnThreshold').value = currentSettings.moderation?.warn_threshold || 5;
            document.getElementById('kickThreshold').value = currentSettings.moderation?.kick_threshold || 3;
            document.getElementById('defaultTimeout').value = currentSettings.moderation?.default_timeout || 60;

            // Populate automod
            document.getElementById('spamDetection').checked = currentSettings.automod?.spam_detection || false;
            document.getElementById('capsDetection').checked = currentSettings.automod?.caps_detection || false;
            document.getElementById('mentionLimit').value = currentSettings.automod?.mention_limit || 5;

            // Populate logging
            document.getElementById('logChannel').value = currentSettings.logging?.channel_id || '';
            document.getElementById('logMessages').checked = currentSettings.logging?.log_messages || false;
            document.getElementById('logEdits').checked = currentSettings.logging?.log_edits || false;
            document.getElementById('logMember').checked = currentSettings.logging?.log_member_updates || false;

            // Populate welcome
            document.getElementById('welcomeEnabled').checked = currentSettings.welcome?.enabled || false;
            document.getElementById('welcomeChannel').value = currentSettings.welcome?.channel_id || '';
            document.getElementById('welcomeMessage').value = currentSettings.welcome?.message || '';

            // Populate bad words
            renderBadWords();

            // Populate links
            renderLinks();

            // Populate music
            document.getElementById('musicEnabled').checked = currentSettings.music_settings?.enabled || false;
            document.getElementById('maxQueueSize').value = currentSettings.music_settings?.max_queue || 100;

            // Populate games
            document.getElementById('gamesEnabled').checked = currentSettings.games_settings?.enabled || false;

            // Populate general
            document.getElementById('prefix').value = currentSettings.prefix || '!';
            document.getElementById('language').value = currentSettings.language || 'en';
        }

        function renderBadWords() {
            const list = document.getElementById('badWordsList');
            list.innerHTML = '';
            currentSettings.bad_words?.forEach(word => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `${word} <button type="button" class="remove-btn" onclick="removeBadWord('${word}')">×</button>`;
                list.appendChild(tag);
            });
        }

        function renderLinks() {
            const list = document.getElementById('linksList');
            list.innerHTML = '';
            currentSettings.whitelisted_links?.forEach(link => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `${link} <button type="button" class="remove-btn" onclick="removeLink('${link}')">×</button>`;
                list.appendChild(tag);
            });
        }

        function addBadWord() {
            const input = document.getElementById('newBadWord');
            const word = input.value.trim().toLowerCase();
            if (word && !currentSettings.bad_words.includes(word)) {
                currentSettings.bad_words.push(word);
                renderBadWords();
                input.value = '';
            }
        }

        function removeBadWord(word) {
            currentSettings.bad_words = currentSettings.bad_words.filter(w => w !== word);
            renderBadWords();
        }

        function addLink() {
            const input = document.getElementById('newLink');
            const link = input.value.trim().toLowerCase();
            if (link && !currentSettings.whitelisted_links.includes(link)) {
                currentSettings.whitelisted_links.push(link);
                renderLinks();
                input.value = '';
            }
        }

        function removeLink(link) {
            currentSettings.whitelisted_links = currentSettings.whitelisted_links.filter(l => l !== link);
            renderLinks();
        }

        // Save settings
        document.querySelectorAll('.settings-form').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                // Gather form data
                const formData = new FormData(form);
                const data = {};

                for (let [key, value] of formData.entries()) {
                    if (key.includes('[')) {
                        const parts = key.match(/(\w+)\[(\w+)\]/);
                        if (parts) {
                            if (!data[parts[1]]) data[parts[1]] = {};
                            data[parts[1]][parts[2]] = value === 'on' ? true : value;
                        }
                    } else {
                        data[key] = value;
                    }
                }

                // Include lists
                data.bad_words = currentSettings.bad_words;
                data.whitelisted_links = currentSettings.whitelisted_links;

                try {
                    const response = await fetch(`/api/settings/${guildId}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        alert('Settings saved successfully!');
                    } else {
                        alert('Failed to save settings');
                    }
                } catch (error) {
                    console.error('Save error:', error);
                    alert('Error saving settings');
                }
            });
        });

        // Load settings on page load
        document.addEventListener('DOMContentLoaded', loadSettings);
    </script>
</body>
</html>
